(window.webpackJsonp=window.webpackJsonp||[]).push([[55],{368:function(s,a,t){"use strict";t.r(a);var v=t(27),_=Object(v.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"一次挖矿病毒的排查经历与思考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一次挖矿病毒的排查经历与思考"}},[s._v("#")]),s._v(" 一次挖矿病毒的排查经历与思考")]),s._v(" "),a("p",[s._v("服务器安全是每个运维人员的必修课。最近，我处理了一起典型的挖矿病毒入侵事件。服务器表现为 CPU 占用率持续 100%，通过一系列排查，最终定位并清除了病毒。我将整个过程记录下来，希望能为遇到类似问题的朋友提供一些排查思路和安全加固的建议。")]),s._v(" "),a("h2",{attrs:{id:"现象-cpu-占用率飙升"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#现象-cpu-占用率飙升"}},[s._v("#")]),s._v(" 现象：CPU 占用率飙升")]),s._v(" "),a("p",[s._v("一切始于监控系统发出的告警：一台服务器的 CPU 使用率长时间维持在 100%。登录服务器后，执行 "),a("code",[s._v("top")]),s._v(" 命令，果然发现一个或多个可疑进程占用了几乎所有的 CPU 资源。")]),s._v(" "),a("h2",{attrs:{id:"排查步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#排查步骤"}},[s._v("#")]),s._v(" 排查步骤")]),s._v(" "),a("p",[s._v("面对这种情况，我们的核心目标是："),a("strong",[s._v("找到并理解这个异常进程，然后清除它以及它的持久化机制。")])]),s._v(" "),a("h3",{attrs:{id:"_1-定位异常进程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-定位异常进程"}},[s._v("#")]),s._v(" 1. 定位异常进程")]),s._v(" "),a("p",[a("code",[s._v("top")]),s._v(" 命令是我们的第一利器。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v("\n")])])]),a("p",[s._v("进入 "),a("code",[s._v("top")]),s._v(" 界面后，可以按 "),a("code",[s._v("P")]),s._v("（大写）让进程按 CPU 使用率降序排列，这样占用最高的进程就会显示在最上方。但默认情况下，"),a("code",[s._v("top")]),s._v(" 显示的命令名可能会被截断，我们需要看到完整的命令行才能获取更多信息。")]),s._v(" "),a("ul",[a("li",[s._v("在 "),a("code",[s._v("top")]),s._v(" 界面，按下 "),a("code",[s._v("c")]),s._v(" 键，可以切换显示完整的命令行。")])]),s._v(" "),a("p",[s._v("通过完整的命令行，我发现了一个名为 "),a("code",[s._v("networkSync")]),s._v(" 的可疑进程。它的命令行参数非常扎眼：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("/tmp/networkSync -o stratum+tcp://auto.c3pool.org:19999 -u 457KQKqFtyg9WtcHQdvok4N6uRZstLmPzFrPv2ewNjHeSRP1MyFFw2zHHjCpm7JoYgMGSpwCw+\n")])])]),a("ul",[a("li",[a("code",[s._v("/tmp/networkSync")]),s._v("：病毒主体放在了 "),a("code",[s._v("/tmp")]),s._v(" 目录下，这是一个常见的藏匿手法，因为 "),a("code",[s._v("/tmp")]),s._v(" 目录通常权限宽松。")]),s._v(" "),a("li",[a("code",[s._v("stratum+tcp://auto.c3pool.org:19999")]),s._v("：这明显是一个矿池的地址。")]),s._v(" "),a("li",[a("code",[s._v("-u 457K...")]),s._v("：后面跟着的长字符串，毫无疑问是挖矿用的钱包地址。")])]),s._v(" "),a("p",[s._v("至此，基本可以断定这是一起挖矿病毒事件。")]),s._v(" "),a("h3",{attrs:{id:"_2-深入分析进程信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-深入分析进程信息"}},[s._v("#")]),s._v(" 2. 深入分析进程信息")]),s._v(" "),a("p",[s._v("有时候，"),a("code",[s._v("top")]),s._v(" 的输出可能因为屏幕宽度限制还是无法显示全部命令。这时，"),a("code",[s._v("ps")]),s._v(" 命令就派上用场了。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 假设通过 top 查到进程的 PID 是 2094448")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2094448")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" cmd --no-headers\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果命令行太长，可以重定向到文件查看")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2094448")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" cmd --no-headers "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" process_command.log\n")])])]),a("h3",{attrs:{id:"_3-寻找入侵途径"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-寻找入侵途径"}},[s._v("#")]),s._v(" 3. 寻找入侵途径")]),s._v(" "),a("p",[s._v("清除了病毒进程（"),a("code",[s._v("kill -9 <PID>")]),s._v("）只是第一步，如果不堵住漏洞，它很快就会卷土重来。我们需要弄清楚攻击者是如何进来的。")]),s._v(" "),a("p",[s._v("SSH 弱口令爆破是最常见的入侵方式之一。我们可以通过查看 SSH 的登录日志来寻找线索。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 实时监控 SSH 登录日志")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" /var/log/auth.log\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看完整的日志文件，搜索失败的登录尝试")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Failed password"')]),s._v(" /var/log/auth.log\n")])])]),a("p",[s._v("通过分析日志，我发现了大量的来自陌生 IP 的登录失败记录，紧接着是一个成功登录的记录。这证实了服务器的某个账户存在弱密码，被攻击者通过暴力破解成功登录。")]),s._v(" "),a("h3",{attrs:{id:"_4-清除病毒与持久化机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-清除病毒与持久化机制"}},[s._v("#")]),s._v(" 4. 清除病毒与持久化机制")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("杀死进程")]),s._v("："),a("code",[s._v("kill -9 <PID>")])]),s._v(" "),a("li",[a("strong",[s._v("删除病毒文件")]),s._v("："),a("code",[s._v("rm /tmp/networkSync")])]),s._v(" "),a("li",[a("strong",[s._v("检查定时任务")]),s._v("：攻击者通常会创建定时任务来实现病毒的持久化和“复活”。"),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("crontab")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查 /etc/crontab 以及 /etc/cron.* 目录下的所有文件")]),s._v("\n")])])])]),s._v(" "),a("li",[a("strong",[s._v("检查系统服务")]),s._v("：更高级的病毒可能会将自己注册为系统服务。"),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("systemctl list-unit-files "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" enabled\n")])])])])]),s._v(" "),a("h2",{attrs:{id:"安全加固措施"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安全加固措施"}},[s._v("#")]),s._v(" 安全加固措施")]),s._v(" "),a("p",[s._v("亡羊补牢，为时未晚。在清除了病毒之后，必须立即进行安全加固，防止再次被入侵。")]),s._v(" "),a("h3",{attrs:{id:"_1-强化-ssh-安全"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-强化-ssh-安全"}},[s._v("#")]),s._v(" 1. 强化 SSH 安全")]),s._v(" "),a("ul",[a("li",[a("p",[a("strong",[s._v("禁用密码登录，强制使用密钥登录")]),s._v("：这是最有效的防爆破手段。编辑 "),a("code",[s._v("/etc/ssh/sshd_config")]),s._v("，设置 "),a("code",[s._v("PasswordAuthentication no")]),s._v("。")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("修改默认端口")]),s._v("：将默认的 22 端口改为其他不常用的端口。")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("禁用 root 用户直接登录")]),s._v("：设置 "),a("code",[s._v("PermitRootLogin no")]),s._v("。")])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("配置登录白名单")]),s._v("：使用 "),a("code",[s._v("AllowUsers")]),s._v(" 指令，或者配置 "),a("code",[s._v("hosts.allow")]),s._v(" 和 "),a("code",[s._v("hosts.deny")]),s._v(" 来限制可以登录的 IP 地址。")]),s._v(" "),a("p",[a("strong",[s._v("示例：使用 "),a("code",[s._v("hosts.allow")]),s._v(" 和 "),a("code",[s._v("hosts.deny")])])]),s._v(" "),a("p",[s._v("a.  "),a("strong",[s._v("编辑 "),a("code",[s._v("/etc/hosts.deny")])]),s._v("，禁止所有 IP 通过 SSH 登录：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("```\nsshd: ALL\n```\n")])])]),a("p",[s._v("b.  "),a("strong",[s._v("编辑 "),a("code",[s._v("/etc/hosts.allow")])]),s._v("，添加允许登录的白名单 IP：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("```\n# 只允许 192.168.1.3 这个 IP 登录\nsshd: 192.168.1.3\n```\n系统会先检查 `hosts.allow`，如果匹配成功则直接放行；否则，再去检查 `hosts.deny`。\n")])])])])]),s._v(" "),a("h3",{attrs:{id:"_2-定期审计与更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-定期审计与更新"}},[s._v("#")]),s._v(" 2. 定期审计与更新")]),s._v(" "),a("ul",[a("li",[s._v("定期检查服务器上的用户和权限。")]),s._v(" "),a("li",[s._v("及时更新系统和软件包，修复已知的安全漏洞。")]),s._v(" "),a("li",[s._v("使用 "),a("code",[s._v("fail2ban")]),s._v(" 等工具来自动阻止恶意爆破的 IP。")])]),s._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("p",[s._v("这次挖矿病毒的排查是一次典型的服务器安全实战。它提醒我们，安全是一个持续的过程，而不是一次性的配置。从设置强密码、使用密钥登录，到配置防火墙规则和定期审计，每一个环节都不能掉以轻心。只有建立起纵深防御的体系，才能最大限度地保护我们的服务器免受侵害。")])])}),[],!1,null,null,null);a.default=_.exports}}]);