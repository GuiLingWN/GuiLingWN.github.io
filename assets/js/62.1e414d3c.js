(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{375:function(s,t,a){"use strict";a.r(t);var n=a(27),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"nginx-转发-ssh-与-mysql-配置指南"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx-转发-ssh-与-mysql-配置指南"}},[s._v("#")]),s._v(" Nginx 转发 SSH 与 MySQL 配置指南")]),s._v(" "),t("p",[s._v("Nginx 不仅可以作为 HTTP 服务器和反向代理，还可以通过 stream 模块实现 TCP/UDP 流量的转发，这使得 Nginx 能够转发 SSH、MySQL 等非 HTTP 协议的流量。")]),s._v(" "),t("h2",{attrs:{id:"stream-模块配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#stream-模块配置"}},[s._v("#")]),s._v(" Stream 模块配置")]),s._v(" "),t("p",[s._v("要使用 Nginx 转发 SSH 和 MySQL，需要确保 Nginx 编译时包含了 stream 模块。")]),s._v(" "),t("h3",{attrs:{id:"转发-ssh-连接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#转发-ssh-连接"}},[s._v("#")]),s._v(" 转发 SSH 连接")]),s._v(" "),t("div",{staticClass:"language-nginx extra-class"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("events")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("    \n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("worker_connections")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("accept_mutex")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("on")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("stream")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("upstream")]),s._v(" ssh")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" IP:22")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9898")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" ssh")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_connect_timeout")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5s")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_timeout")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30s")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("h3",{attrs:{id:"转发-mysql-连接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#转发-mysql-连接"}},[s._v("#")]),s._v(" 转发 MySQL 连接")]),s._v(" "),t("div",{staticClass:"language-nginx extra-class"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("stream")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_connect_timeout")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5s")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_timeout")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("300s")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" IP:3306")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("h2",{attrs:{id:"检查和启用-stream-模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#检查和启用-stream-模块"}},[s._v("#")]),s._v(" 检查和启用 Stream 模块")]),s._v(" "),t("h3",{attrs:{id:"检查-nginx-是否支持-stream-模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#检查-nginx-是否支持-stream-模块"}},[s._v("#")]),s._v(" 检查 Nginx 是否支持 Stream 模块")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("nginx "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-V")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" -- --with-stream\n")])])]),t("p",[s._v("如果输出包含 "),t("code",[s._v("--with-stream")]),s._v("，说明 Nginx 支持 stream 模块。")]),s._v(" "),t("p",[s._v("如果遇到以下错误：")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('nginx: [emerg] unknown directive "stream" in /etc/nginx/nginx.conf:224\n')])])]),t("p",[s._v("说明 Nginx 是以动态模块的方式支持 "),t("code",[s._v("stream")]),s._v(" 模块：")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("--with-stream=dynamic --with-stream_ssl_module\n")])])]),t("p",[s._v("在这种情况下，需要在 "),t("code",[s._v("/etc/nginx/nginx.conf")]),s._v(" 文件的最顶端添加：")]),s._v(" "),t("div",{staticClass:"language-nginx extra-class"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("load_module")]),s._v(" modules/ngx_stream_module.so")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("h2",{attrs:{id:"ubuntu-系统下-nginx-安装与卸载"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ubuntu-系统下-nginx-安装与卸载"}},[s._v("#")]),s._v(" Ubuntu 系统下 Nginx 安装与卸载")]),s._v(" "),t("h3",{attrs:{id:"安装-nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装-nginx"}},[s._v("#")]),s._v(" 安装 Nginx")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" nginx\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看安装版本")]),s._v("\nnginx "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动 Nginx")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" nginx start\n")])])]),t("p",[s._v("Nginx 安装完成后的文件位置：")]),s._v(" "),t("ul",[t("li",[s._v("/usr/sbin/nginx：主程序")]),s._v(" "),t("li",[s._v("/etc/nginx：存放配置文件")]),s._v(" "),t("li",[s._v("/usr/share/nginx：存放静态文件")]),s._v(" "),t("li",[s._v("/var/log/nginx：存放日志")])]),s._v(" "),t("h3",{attrs:{id:"卸载-nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#卸载-nginx"}},[s._v("#")]),s._v(" 卸载 Nginx")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除 nginx，--purge 包括配置文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--purge")]),s._v(" remove nginx\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自动移除全部不使用的软件包")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" autoremove\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 罗列出与 nginx 相关的软件")]),s._v("\ndpkg --get-selections"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" nginx\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除查询出与 nginx 有关的软件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--purge")]),s._v(" remove nginx\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--purge")]),s._v(" remove nginx-common\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--purge")]),s._v(" remove nginx-full\n")])])]),t("h2",{attrs:{id:"使用场景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用场景"}},[s._v("#")]),s._v(" 使用场景")]),s._v(" "),t("p",[s._v("通过 Nginx 转发 SSH 和 MySQL 连接，可以实现以下场景：")]),s._v(" "),t("ol",[t("li",[t("strong",[s._v("安全访问")]),s._v("：通过 Nginx 代理访问内网的 SSH 和 MySQL 服务，避免直接暴露服务端口")]),s._v(" "),t("li",[t("strong",[s._v("负载均衡")]),s._v("：对多个 MySQL 实例进行负载均衡")]),s._v(" "),t("li",[t("strong",[s._v("访问控制")]),s._v("：通过 Nginx 的访问控制功能限制对 SSH 和 MySQL 的访问")]),s._v(" "),t("li",[t("strong",[s._v("日志记录")]),s._v("：记录 SSH 和 MySQL 的访问日志，便于审计和监控")])]),s._v(" "),t("h2",{attrs:{id:"注意事项"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#注意事项"}},[s._v("#")]),s._v(" 注意事项")]),s._v(" "),t("ol",[t("li",[s._v("确保 Nginx 版本支持 stream 模块（如 1.18.0 及以上版本）")]),s._v(" "),t("li",[s._v("配置完成后需要重启 Nginx 服务使配置生效")]),s._v(" "),t("li",[s._v("注意防火墙设置，确保转发端口可以正常访问")]),s._v(" "),t("li",[s._v("合理设置超时时间，避免连接异常断开")])]),s._v(" "),t("p",[s._v("通过以上配置，可以实现通过 Nginx 转发 SSH 和 MySQL 连接，为内网服务提供安全的外部访问方式。")])])}),[],!1,null,null,null);t.default=e.exports}}]);