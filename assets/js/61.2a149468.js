(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{374:function(a,s,t){"use strict";t.r(s);var n=t(27),e=Object(n.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"nginx-访问日志分析与定时处理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-访问日志分析与定时处理"}},[a._v("#")]),a._v(" Nginx 访问日志分析与定时处理")]),a._v(" "),s("p",[a._v("Nginx 访问日志是了解网站流量、用户行为和系统性能的重要数据源。本文将介绍如何分析 Nginx 访问日志以及如何设置定时任务自动处理日志文件。")]),a._v(" "),s("h2",{attrs:{id:"nginx-访问日志分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-访问日志分析"}},[a._v("#")]),a._v(" Nginx 访问日志分析")]),a._v(" "),s("p",[a._v("分析 Nginx 访问日志需要在 shell 环境下进行，通过各种命令行工具可以提取有价值的信息。")]),a._v(" "),s("h3",{attrs:{id:"日志分析基础"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#日志分析基础"}},[a._v("#")]),a._v(" 日志分析基础")]),a._v(" "),s("p",[a._v("Nginx 访问日志记录了每个请求的详细信息，包括：")]),a._v(" "),s("ul",[s("li",[a._v("客户端 IP 地址")]),a._v(" "),s("li",[a._v("请求时间")]),a._v(" "),s("li",[a._v("请求方法和 URL")]),a._v(" "),s("li",[a._v("HTTP 状态码")]),a._v(" "),s("li",[a._v("响应大小")]),a._v(" "),s("li",[a._v("User-Agent 信息")]),a._v(" "),s("li",[a._v("引荐页面等")])]),a._v(" "),s("p",[a._v("通过分析这些信息，可以了解：")]),a._v(" "),s("ul",[s("li",[a._v("网站的访问量和访问趋势")]),a._v(" "),s("li",[a._v("用户的访问行为和偏好")]),a._v(" "),s("li",[a._v("系统的性能瓶颈")]),a._v(" "),s("li",[a._v("潜在的安全威胁")])]),a._v(" "),s("h2",{attrs:{id:"日志处理定时任务脚本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#日志处理定时任务脚本"}},[a._v("#")]),a._v(" 日志处理定时任务脚本")]),a._v(" "),s("p",[a._v("为了防止日志文件过大和便于管理，可以设置定时任务定期处理和轮转日志文件。")]),a._v(" "),s("h3",{attrs:{id:"windows-环境下的批处理脚本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#windows-环境下的批处理脚本"}},[a._v("#")]),a._v(" Windows 环境下的批处理脚本")]),a._v(" "),s("div",{staticClass:"language-batch extra-class"},[s("pre",{pre:!0,attrs:{class:"language-batch"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("@")]),s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("echo")]),a._v(" off")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("cd")]),a._v(" C:\\nginx")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("set")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("today")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("%date:~2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("%%date:~5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("%%date:~8")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("%_%")]),a._v("time:"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("~")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("%%time:~3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("%")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("set")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("path")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("C:\\nginx\\logs\\access\\"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("%today%")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("move")]),a._v(" C:\\nginx\\logs\\access.log "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("%path%")]),a._v(".log")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token command"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("nginx")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[a._v("-s")]),a._v(" reload")]),a._v("\n")])])]),s("p",[a._v("该脚本的作用：")]),a._v(" "),s("ol",[s("li",[a._v("切换到 Nginx 目录")]),a._v(" "),s("li",[a._v("生成当前日期时间戳")]),a._v(" "),s("li",[a._v("创建日志备份路径")]),a._v(" "),s("li",[a._v("移动当前访问日志到备份位置")]),a._v(" "),s("li",[a._v("重新加载 Nginx 配置，生成新的日志文件")])]),a._v(" "),s("h3",{attrs:{id:"linux-环境下的-shell-脚本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#linux-环境下的-shell-脚本"}},[a._v("#")]),a._v(" Linux 环境下的 Shell 脚本")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token shebang important"}},[a._v("#!/bin/bash")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 设置日志目录和文件名")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("LOG_PATH")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/var/log/nginx"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("DATE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"yesterday"')]),a._v(" +"),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"%Y%m%d"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建备份目录")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${LOG_PATH}")]),a._v("/backup\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 移动日志文件")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mv")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${LOG_PATH}")]),a._v("/access.log "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${LOG_PATH}")]),a._v("/backup/access_"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${DATE}")]),a._v(".log\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 重新加载 Nginx")]),a._v("\nnginx "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" reload\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 可选：压缩旧日志文件")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("gzip")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${LOG_PATH}")]),a._v("/backup/access_"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${DATE}")]),a._v(".log\n")])])]),s("h3",{attrs:{id:"设置定时任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#设置定时任务"}},[a._v("#")]),a._v(" 设置定时任务")]),a._v(" "),s("p",[a._v("在 Linux 系统中，可以通过 crontab 设置定时任务：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 编辑定时任务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("crontab")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 添加以下行，每天凌晨 1 点执行日志轮转")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" * * * /path/to/nginx_log_rotate.sh\n")])])]),s("h2",{attrs:{id:"nginx-文件位置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-文件位置"}},[a._v("#")]),a._v(" Nginx 文件位置")]),a._v(" "),s("p",[a._v("Nginx 安装完成后，各组件的默认位置：")]),a._v(" "),s("ul",[s("li",[a._v("/usr/sbin/nginx：主程序")]),a._v(" "),s("li",[a._v("/etc/nginx：存放配置文件")]),a._v(" "),s("li",[a._v("/usr/share/nginx：存放静态文件")]),a._v(" "),s("li",[a._v("/var/log/nginx：存放日志")])]),a._v(" "),s("h2",{attrs:{id:"日志分析工具"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#日志分析工具"}},[a._v("#")]),a._v(" 日志分析工具")]),a._v(" "),s("p",[a._v("除了手动分析日志外，还可以使用一些专业的日志分析工具：")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("GoAccess")]),a._v("：实时 Web 日志分析器和交互式查看器")]),a._v(" "),s("li",[s("strong",[a._v("AWStats")]),a._v("：功能强大的日志分析工具")]),a._v(" "),s("li",[s("strong",[a._v("Piwik/Matomo")]),a._v("：开源的 Web 分析平台")])]),a._v(" "),s("h3",{attrs:{id:"使用-goaccess-分析-nginx-日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用-goaccess-分析-nginx-日志"}},[a._v("#")]),a._v(" 使用 GoAccess 分析 Nginx 日志")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 安装 GoAccess")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" goaccess\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 实时分析日志")]),a._v("\ngoaccess /var/log/nginx/access.log "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-c")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 生成 HTML 报告")]),a._v("\ngoaccess /var/log/nginx/access.log "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-o")]),a._v(" /var/www/html/report.html --log-format"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("COMBINED\n")])])]),s("h2",{attrs:{id:"日志轮转策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#日志轮转策略"}},[a._v("#")]),a._v(" 日志轮转策略")]),a._v(" "),s("p",[a._v("合理的日志轮转策略可以有效管理磁盘空间和提高日志可读性：")]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("按时间轮转")]),a._v("：每天、每周或每月生成新的日志文件")]),a._v(" "),s("li",[s("strong",[a._v("按大小轮转")]),a._v("：当日志文件达到指定大小时进行轮转")]),a._v(" "),s("li",[s("strong",[a._v("压缩旧日志")]),a._v("：对历史日志进行压缩以节省空间")]),a._v(" "),s("li",[s("strong",[a._v("删除过期日志")]),a._v("：定期清理过期的日志文件")])]),a._v(" "),s("h3",{attrs:{id:"使用-logrotate-进行日志轮转"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用-logrotate-进行日志轮转"}},[a._v("#")]),a._v(" 使用 logrotate 进行日志轮转")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建 logrotate 配置文件")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /etc/logrotate.d/nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置内容")]),a._v("\n/var/log/nginx/*.log "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    daily\n    missingok\n    rotate "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("52")]),a._v("\n    compress\n    delaycompress\n    notifempty\n    create "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("644")]),a._v(" nginx nginx\n    sharedscripts\n    postrotate\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f")]),a._v(" /var/run/nginx.pid "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("kill")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-USR1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" /var/run/nginx.pid"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n    endscript\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[a._v("#")]),a._v(" 总结")]),a._v(" "),s("p",[a._v("通过合理分析 Nginx 访问日志和设置定时处理任务，可以：")]),a._v(" "),s("ol",[s("li",[a._v("及时了解网站运行状况")]),a._v(" "),s("li",[a._v("有效管理日志文件大小")]),a._v(" "),s("li",[a._v("为系统优化提供数据支持")]),a._v(" "),s("li",[a._v("提高系统维护效率")])]),a._v(" "),s("p",[a._v("在实际应用中，应根据具体需求选择合适的日志分析方法和处理策略，并定期检查和优化相关配置。")])])}),[],!1,null,null,null);s.default=e.exports}}]);