(window.webpackJsonp=window.webpackJsonp||[]).push([[118],{411:function(a,t,s){"use strict";s.r(t);var r=s(27),e=Object(r.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"使用grafana-loki-promtail搭建日志收集系统"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用grafana-loki-promtail搭建日志收集系统"}},[a._v("#")]),a._v(" 使用Grafana+Loki+Promtail搭建日志收集系统")]),a._v(" "),t("p",[a._v("在微服务架构中，集中化的日志管理非常重要。Grafana+Loki+Promtail是一套轻量级的日志收集和查询方案。本文记录了使用Docker部署这套系统的完整过程。")]),a._v(" "),t("h2",{attrs:{id:"系统架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#系统架构"}},[a._v("#")]),a._v(" 系统架构")]),a._v(" "),t("ul",[t("li",[t("strong",[a._v("Loki")]),a._v("：日志聚合系统，类似Prometheus但专注于日志")]),a._v(" "),t("li",[t("strong",[a._v("Promtail")]),a._v("：日志采集器，负责收集和推送日志到Loki")]),a._v(" "),t("li",[t("strong",[a._v("Grafana")]),a._v("：可视化界面，用于查询和展示日志")])]),a._v(" "),t("h2",{attrs:{id:"docker部署方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker部署方式"}},[a._v("#")]),a._v(" Docker部署方式")]),a._v(" "),t("h3",{attrs:{id:"_1-安装loki日志采集插件-可选"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装loki日志采集插件-可选"}},[a._v("#")]),a._v(" 1. 安装Loki日志采集插件（可选）")]),a._v(" "),t("p",[a._v("如果需要采集Docker容器日志，可以安装Loki的Docker插件：")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 安装插件")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" plugin "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  docker.mirrors.sjtug.sjtu.edu.cn/grafana/loki-docker-driver:latest "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--alias")]),a._v(" loki "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --grant-all-permissions\n")])])]),t("h3",{attrs:{id:"_2-配置docker全局日志驱动-可选"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-配置docker全局日志驱动-可选"}},[a._v("#")]),a._v(" 2. 配置Docker全局日志驱动（可选）")]),a._v(" "),t("p",[a._v("编辑Docker daemon配置文件：")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 编辑配置文件")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("vi")]),a._v(" /etc/docker/daemon.json\n")])])]),t("p",[a._v("添加以下配置：")]),a._v(" "),t("div",{staticClass:"language-json extra-class"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"log-driver"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"loki"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"log-opts"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"loki-url"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"http://192.168.2.9:3100/loki/api/v1/push"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"max-size"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"50m"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[a._v('"max-file"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"10"')]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),t("p",[a._v("注意：修改后需要重启Docker服务。")]),a._v(" "),t("h3",{attrs:{id:"_3-部署loki"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-部署loki"}},[a._v("#")]),a._v(" 3. 部署Loki")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建数据目录")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" /data/docker/loki\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" /data/docker/loki/index\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" /data/docker/loki/chunks\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 设置目录权限")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-R")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("777")]),a._v(" /data/docker/loki/index\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-R")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("777")]),a._v(" /data/docker/loki/chunks\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 运行Loki容器")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--restart")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("always "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" loki "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--privileged")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /data/docker/loki:/opt/loki "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3100")]),a._v(":3100 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  grafana/loki:2.8.0 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-config.file")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/opt/loki/loki-config.yaml\n")])])]),t("h3",{attrs:{id:"_4-部署promtail"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-部署promtail"}},[a._v("#")]),a._v(" 4. 部署Promtail")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 创建配置目录")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" /data/docker/promtail\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 运行Promtail容器")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--restart")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("always "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" promtail "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--privileged")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /data/docker/promtail:/mnt/config "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /data/logs:/var/log "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /var/log/nginx:/var/log/nginx "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  grafana/promtail "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-config.file")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/mnt/config/promtail-config.yaml\n")])])]),t("h3",{attrs:{id:"_5-部署grafana"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-部署grafana"}},[a._v("#")]),a._v(" 5. 部署Grafana")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--restart")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("always "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" grafana "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3000")]),a._v(":3000 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  grafana/grafana-enterprise:9.2.15\n")])])]),t("h3",{attrs:{id:"_6-部署prometheus-可选"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-部署prometheus-可选"}},[a._v("#")]),a._v(" 6. 部署Prometheus（可选）")]),a._v(" "),t("p",[a._v("如果需要配合Prometheus使用：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" /data/docker/prometheus\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("9090")]),a._v(":9090 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" /data/docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  prom/prometheus\n")])])]),t("h2",{attrs:{id:"配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置文件"}},[a._v("#")]),a._v(" 配置文件")]),a._v(" "),t("h3",{attrs:{id:"loki配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#loki配置文件"}},[a._v("#")]),a._v(" Loki配置文件")]),a._v(" "),t("p",[a._v("需要在"),t("code",[a._v("/data/docker/loki/loki-config.yaml")]),a._v("中添加配置。如果遇到权限问题，需要添加wal目录配置：")]),a._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ingester")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("wal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("enabled")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[a._v("true")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("dir")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" /loki/wal\n")])])]),t("h3",{attrs:{id:"promtail配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#promtail配置文件"}},[a._v("#")]),a._v(" Promtail配置文件")]),a._v(" "),t("p",[a._v("配置文件位置："),t("code",[a._v("/data/docker/promtail/promtail-config.yaml")])]),a._v(" "),t("p",[a._v("可以参考官方配置示例进行定制。")]),a._v(" "),t("h2",{attrs:{id:"常见问题处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#常见问题处理"}},[a._v("#")]),a._v(" 常见问题处理")]),a._v(" "),t("h3",{attrs:{id:"权限错误"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#权限错误"}},[a._v("#")]),a._v(" 权限错误")]),a._v(" "),t("p",[a._v("如果遇到以下错误：")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('msg="error running loki" err="mkdir wal: permission denied"\n')])])]),t("p",[a._v("解决方法：")]),a._v(" "),t("ol",[t("li",[a._v("在配置文件中增加wal目录配置")]),a._v(" "),t("li",[a._v("确保目录权限正确（777或容器内用户可写）")])]),a._v(" "),t("p",[a._v("参考资料：")]),a._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://www.cnblogs.com/xxg98/p/17003148.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("Loki权限问题解决"),t("OutboundLink")],1)]),a._v(" "),t("li",[t("a",{attrs:{href:"https://github.com/grafana/loki/issues/2018",target:"_blank",rel:"noopener noreferrer"}},[a._v("GitHub Issue讨论"),t("OutboundLink")],1)])]),a._v(" "),t("h2",{attrs:{id:"日志管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#日志管理"}},[a._v("#")]),a._v(" 日志管理")]),a._v(" "),t("h3",{attrs:{id:"手动清理历史日志-loki自带的日志清理配置功能经常不生效-所以手动清理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#手动清理历史日志-loki自带的日志清理配置功能经常不生效-所以手动清理"}},[a._v("#")]),a._v(" 手动清理历史日志（loki自带的日志清理配置功能经常不生效，所以手动清理）")]),a._v(" "),t("p",[a._v("随着时间推移，日志文件会占用大量磁盘空间，需要定期清理：")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 统计目录文件数量")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" /data/docker/loki/chunks/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-type")]),a._v(" f "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("wc")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-l")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 查询最早文件创建时间")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" /data/docker/loki/chunks/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-type")]),a._v(" f "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-printf")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'%T@ %p\\n'")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sort")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("head")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-1")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("awk")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'{print strftime(\"%Y-%m-%d %H:%M:%S\", $1)}'")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 列出一年前的文件")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" /data/docker/loki/chunks/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-type")]),a._v(" f "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-mtime")]),a._v(" +365\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 删除一年前的文件")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" /data/docker/loki/chunks/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-type")]),a._v(" f "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-mtime")]),a._v(" +365 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-exec")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 统计100天前文件的总大小（GB）")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" /data/docker/loki/chunks/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-type")]),a._v(" f "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-mtime")]),a._v(" +100 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-exec")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("du")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-b")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v(" + "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("awk")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'{ total += $1 } END { print total/1024/1024/1024 }'")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 统计100天前的文件总数")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" /data/docker/loki/chunks/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-type")]),a._v(" f "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-mtime")]),a._v(" +100 "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("wc")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-l")]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 移动100天前的文件到备份目录")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" /data/docker/loki/chunks/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-type")]),a._v(" f "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-mtime")]),a._v(" +100 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-exec")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mv")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v(" /data/docker/loki/backup/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),t("h3",{attrs:{id:"按月份统计文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#按月份统计文件"}},[a._v("#")]),a._v(" 按月份统计文件")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" /data/docker/loki/chunks/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-type")]),a._v(" f "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-printf")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("'%TY-%Tm %s\\n'")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("awk")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('\'\n{\n    size[$1] += $2\n    count[$1]++\n}\nEND {\n    printf "%-10s %-10s %-15s %-15s\\n", "Month", "Count", "Total Size", "Avg Size"\n    printf "%-10s %-10s %-15s %-15s\\n", "----------", "----------", "---------------", "---------------"\n    for (month in size) {\n        total_gb = size[month] / 1024 / 1024 / 1024\n        avg_kb = count[month] > 0 ? (size[month] / count[month] / 1024) : 0\n        printf "%-10s %-10d %-10.2f GB %-10.2f KB\\n", month, count[month], total_gb, avg_kb\n    }\n}\'')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sort")]),a._v("\n")])])]),t("h2",{attrs:{id:"grafana配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#grafana配置"}},[a._v("#")]),a._v(" Grafana配置")]),a._v(" "),t("ol",[t("li",[a._v("访问Grafana："),t("code",[a._v("http://your-ip:3000")])]),a._v(" "),t("li",[a._v("默认用户名/密码："),t("code",[a._v("admin/admin")])]),a._v(" "),t("li",[a._v("添加Loki数据源：\n"),t("ul",[t("li",[a._v("配置 -> Data Sources -> Add data source")]),a._v(" "),t("li",[a._v("选择 Loki")]),a._v(" "),t("li",[a._v("URL填写："),t("code",[a._v("http://loki:3100")]),a._v("（容器间通信）或"),t("code",[a._v("http://your-ip:3100")])])])]),a._v(" "),t("li",[a._v("创建Dashboard查询日志")])]),a._v(" "),t("h2",{attrs:{id:"参考资料"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[a._v("#")]),a._v(" 参考资料")]),a._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://blog.csdn.net/qq_30442207/article/details/114583870",target:"_blank",rel:"noopener noreferrer"}},[a._v("Docker搭建Grafana+Loki+Promtail日志收集系统"),t("OutboundLink")],1)]),a._v(" "),t("li",[t("a",{attrs:{href:"https://blog.csdn.net/qq_30442207/article/details/114583923",target:"_blank",rel:"noopener noreferrer"}},[a._v("Grafana界面操作展示Loki"),t("OutboundLink")],1)]),a._v(" "),t("li",[t("a",{attrs:{href:"https://wiki.eryajf.net/pages/e8500e/#%E9%87%87%E9%9B%86%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97",target:"_blank",rel:"noopener noreferrer"}},[a._v("采集Docker日志配置"),t("OutboundLink")],1)])]),a._v(" "),t("h2",{attrs:{id:"小结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[a._v("#")]),a._v(" 小结")]),a._v(" "),t("p",[a._v("Grafana+Loki+Promtail提供了一套轻量级且功能强大的日志解决方案，相比ELK栈占用资源更少。通过Docker部署简化了安装过程，但需要注意配置文件和权限问题。定期清理历史日志可以有效控制磁盘占用，保持系统稳定运行。")])])}),[],!1,null,null,null);t.default=e.exports}}]);