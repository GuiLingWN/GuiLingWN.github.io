(window.webpackJsonp=window.webpackJsonp||[]).push([[84],{396:function(a,s,t){"use strict";t.r(s);var e=t(27),n=Object(e.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"mysql-索引优化与-bin-log-管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql-索引优化与-bin-log-管理"}},[a._v("#")]),a._v(" MySQL 索引优化与 bin-log 管理")]),a._v(" "),s("p",[a._v("MySQL 的索引优化和 bin-log 管理是数据库性能调优和数据恢复的重要方面。本文将介绍索引失效的原因、bin-log 的管理方法以及相关的配置优化。")]),a._v(" "),s("h2",{attrs:{id:"索引优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#索引优化"}},[a._v("#")]),a._v(" 索引优化")]),a._v(" "),s("h3",{attrs:{id:"索引失效的原因"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#索引失效的原因"}},[a._v("#")]),a._v(" 索引失效的原因")]),a._v(" "),s("p",[a._v("在数据量大的情况下，MySQL 索引可能会失效，主要原因包括：")]),a._v(" "),s("ol",[s("li",[a._v("查询的数据量可能已经是总数据量的 20% 以上了，这个时候 MySQL 查询优化器会选择表扫描而不是索引扫描。")]),a._v(" "),s("li",[a._v("索引可能存在坏块，需要重建索引。")])]),a._v(" "),s("p",[a._v("当查询涉及大量数据时，MySQL 优化器会基于成本考虑选择全表扫描而非索引扫描，因为全表扫描在某些情况下可能比通过索引随机读取数据更高效。")]),a._v(" "),s("h3",{attrs:{id:"索引重建"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#索引重建"}},[a._v("#")]),a._v(" 索引重建")]),a._v(" "),s("p",[a._v("当怀疑索引出现坏块时，可以通过以下方式重建索引：")]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("-- 重建表的所有索引")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ALTER")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("TABLE")]),a._v(" table_name "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ENGINE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("InnoDB")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("-- 或者删除并重新创建特定索引")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("DROP")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("INDEX")]),a._v(" index_name "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ON")]),a._v(" table_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("CREATE")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("INDEX")]),a._v(" index_name "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ON")]),a._v(" table_name "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("column_list"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("h2",{attrs:{id:"bin-log-管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#bin-log-管理"}},[a._v("#")]),a._v(" bin-log 管理")]),a._v(" "),s("p",[a._v("bin-log（二进制日志）是 MySQL 中非常重要的功能，用于数据恢复和主从复制。")]),a._v(" "),s("h3",{attrs:{id:"查看-bin-log-设置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看-bin-log-设置"}},[a._v("#")]),a._v(" 查看 bin-log 设置")]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("-- 查看日志相关设置")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SHOW")]),a._v(" VARIABLES "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("LIKE")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'%log_%'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("-- 查看二进制日志文件列表")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SHOW")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("BINARY")]),a._v(" LOGS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("-- 查看二进制日志中的操作记录")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SHOW")]),a._v(" BINLOG EVENTS "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("IN")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'binlog_file_name'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("h3",{attrs:{id:"bin-log-文件处理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#bin-log-文件处理"}},[a._v("#")]),a._v(" bin-log 文件处理")]),a._v(" "),s("p",[a._v("在命令行中处理 bin-log 文件：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 进入 mysql/bin 目录，将 bin-log 文件转换为 SQL")]),a._v("\nmysqlbinlog "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" database_name /path/to/binlog_file "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" backup.sql\n")])])]),s("h3",{attrs:{id:"group-concat-长度限制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#group-concat-长度限制"}},[a._v("#")]),a._v(" group_concat 长度限制")]),a._v(" "),s("p",[a._v("MySQL 的 "),s("code",[a._v("group_concat")]),a._v(" 函数默认连接长度为 1024 字符，超过这个长度的部分会被截断。")]),a._v(" "),s("p",[a._v("查看当前限制：")]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SELECT")]),a._v(" @"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("@global.group_concat_max_len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SHOW")]),a._v(" VARIABLES "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("LIKE")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"group_concat_max_len"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("p",[a._v("设置更长的限制：")]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("-- 全局设置")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SET")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("GLOBAL")]),a._v(" group_concat_max_len"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("102400")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("-- 会话设置")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SET")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SESSION")]),a._v(" group_concat_max_len"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("102400")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("p",[a._v("在 MySQL 配置文件中永久设置：")]),a._v(" "),s("div",{staticClass:"language-ini extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[s("span",{pre:!0,attrs:{class:"token section"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("mysqld")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("group_concat_max_len")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("102400")]),a._v("\n")])])]),s("p",[a._v("设置后需要重启 MySQL 服务才能生效。")]),a._v(" "),s("h2",{attrs:{id:"批量删除表操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#批量删除表操作"}},[a._v("#")]),a._v(" 批量删除表操作")]),a._v(" "),s("p",[a._v("在需要删除数据库中的多个表时，可以通过 SQL 语句生成批量删除语句：")]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SELECT")]),a._v(" CONCAT"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'DROP TABLE '")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" table_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("';'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("FROM")]),a._v(" information_schema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("TABLES")]),a._v(" \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("WHERE")]),a._v(" table_schema"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'database_name'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("p",[a._v("修改 "),s("code",[a._v("database_name")]),a._v(" 为实际的数据库名，执行该 SQL 会返回所有表的删除语句，复制并执行即可。")]),a._v(" "),s("h2",{attrs:{id:"字符集与排序规则问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#字符集与排序规则问题"}},[a._v("#")]),a._v(" 字符集与排序规则问题")]),a._v(" "),s("p",[a._v("在 MySQL 8.0 中，字符集和排序规则有所变化，可能会导致兼容性问题。")]),a._v(" "),s("h3",{attrs:{id:"排序规则不匹配错误"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#排序规则不匹配错误"}},[a._v("#")]),a._v(" 排序规则不匹配错误")]),a._v(" "),s("p",[a._v("错误信息：")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("SQL 错误(1267)：Illegal mix of collations (utf8mb4_general_ci,IMPLICIT) and (utf8mb4_0900_ai_ci,IMPLICIT) for operation '='\n")])])]),s("p",[a._v("解决方法：")]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("-- 在查询中显式指定排序规则")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("UPDATE")]),a._v(" b_stock_product b \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SET")]),a._v(" b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("dewu_app_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("SELECT")]),a._v(" app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("id \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("FROM")]),a._v(" b_dewu_app app \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("WHERE")]),a._v(" app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("business_code "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("business_code "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("COLLATE")]),a._v(" utf8mb4_general_ci\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("h3",{attrs:{id:"版本兼容性问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#版本兼容性问题"}},[a._v("#")]),a._v(" 版本兼容性问题")]),a._v(" "),s("p",[a._v("从 MySQL 8.0 向低版本（如 5.6）导入数据时，可能会遇到字符集兼容性问题：")]),a._v(" "),s("p",[a._v("解决方法：")]),a._v(" "),s("ol",[s("li",[a._v("将文件中的所有 "),s("code",[a._v("utf8mb4_0900_ai_ci")]),a._v(" 替换为 "),s("code",[a._v("utf8mb4_general_ci")])]),a._v(" "),s("li",[a._v("将 "),s("code",[a._v("utf8mb4")]),a._v(" 替换为 "),s("code",[a._v("utf8")])])]),a._v(" "),s("h2",{attrs:{id:"my-cnf-配置文件位置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#my-cnf-配置文件位置"}},[a._v("#")]),a._v(" my.cnf 配置文件位置")]),a._v(" "),s("p",[a._v("在 Docker 环境中，MySQL 的数据存储目录和配置文件位置：")]),a._v(" "),s("p",[a._v("数据存储目录：")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("/var/lib/mysql\n")])])]),s("p",[a._v("配置文件位置：")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("/etc/mysql/my.cnf \n/etc/mysql/conf.d\n")])])]),s("p",[a._v("MySQL 启动时会加载 "),s("code",[a._v("/etc/mysql/my.cnf")]),a._v(" 配置文件，该文件最后会 include "),s("code",[a._v("/etc/mysql/conf.d")]),a._v(" 目录下的所有 "),s("code",[a._v(".cnf")]),a._v(" 配置文件。")]),a._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[a._v("#")]),a._v(" 总结")]),a._v(" "),s("p",[a._v("合理的索引优化和 bin-log 管理对于 MySQL 数据库的性能和数据安全至关重要。在实际使用中，应：")]),a._v(" "),s("ol",[s("li",[a._v("定期检查索引使用情况，避免索引失效")]),a._v(" "),s("li",[a._v("合理配置 bin-log 相关参数，确保数据安全")]),a._v(" "),s("li",[a._v("注意字符集和排序规则的兼容性问题")]),a._v(" "),s("li",[a._v("正确设置 group_concat 等函数的长度限制")]),a._v(" "),s("li",[a._v("熟悉配置文件的位置和加载顺序")])]),a._v(" "),s("p",[a._v("通过掌握这些技巧，可以更好地管理和优化 MySQL 数据库。")])])}),[],!1,null,null,null);s.default=n.exports}}]);